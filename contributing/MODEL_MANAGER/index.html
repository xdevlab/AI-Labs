
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="mauwii">
      
      
        <link rel="canonical" href="https://invoke-ai.github.io/InvokeAI/contributing/MODEL_MANAGER/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.19">
    
    
      
        <title>Introduction to the Model Manager V2 - InvokeAI Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-2X4JR4S4FB"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-2X4JR4S4FB",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-2X4JR4S4FB",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction-to-the-model-manager-v2" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="InvokeAI Documentation" class="md-header__button md-logo" aria-label="InvokeAI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            InvokeAI Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Introduction to the Model Manager V2
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/invoke-ai/InvokeAI" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    invoke-ai/InvokeAI
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../installation/INSTALLATION/" class="md-tabs__link">
        Installation
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../nodes/communityNodes/" class="md-tabs__link">
        Workflows & Nodes
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../features/" class="md-tabs__link">
        Features
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../CONTRIBUTING/" class="md-tabs__link">
        Contributing
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../CHANGELOG/" class="md-tabs__link">
      Changelog
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../deprecated/CLI/" class="md-tabs__link">
        Deprecated
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../help/gettingStartedWithAI/" class="md-tabs__link">
        Help
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../other/CONTRIBUTORS/" class="md-tabs__link">
        Other
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="InvokeAI Documentation" class="md-nav__button md-logo" aria-label="InvokeAI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    InvokeAI Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/invoke-ai/InvokeAI" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    invoke-ai/InvokeAI
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/INSTALLATION/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/010_INSTALL_AUTOMATED/" class="md-nav__link">
        Installing with the Automated Installer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/020_INSTALL_MANUAL/" class="md-nav__link">
        Installing Manually
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/030_INSTALL_CUDA_AND_ROCM/" class="md-nav__link">
        NVIDIA Cuda / AMD ROCm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/040_INSTALL_DOCKER/" class="md-nav__link">
        Installing with Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/050_INSTALLING_MODELS/" class="md-nav__link">
        Installing Models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/060_INSTALL_PATCHMATCH/" class="md-nav__link">
        Installing PyPatchMatch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/070_INSTALL_XFORMERS/" class="md-nav__link">
        Installing xFormers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/Developers_documentation/BUILDING_BINARY_INSTALLERS/" class="md-nav__link">
        Developers Documentation
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
          Deprecated Documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_10">
          <span class="md-nav__icon md-icon"></span>
          Deprecated Documentation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/deprecated_documentation/INSTALL_BINARY/" class="md-nav__link">
        Binary Installer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/deprecated_documentation/INSTALL_JUPYTER/" class="md-nav__link">
        Runninng InvokeAI on Google Colab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/deprecated_documentation/INSTALL_LINUX/" class="md-nav__link">
        Manual Installation on Linux
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/deprecated_documentation/INSTALL_MAC/" class="md-nav__link">
        Manual Installation on macOS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/deprecated_documentation/INSTALL_WINDOWS/" class="md-nav__link">
        Manual Installation on Windows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/deprecated_documentation/INSTALL_PCP/" class="md-nav__link">
        Installing Invoke with pip
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/deprecated_documentation/INSTALL_SOURCE/" class="md-nav__link">
        Source Installer
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Workflows & Nodes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Workflows & Nodes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nodes/communityNodes/" class="md-nav__link">
        Community Nodes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nodes/exampleWorkflows/" class="md-nav__link">
        Example Workflows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nodes/overview/" class="md-nav__link">
        Nodes Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nodes/defaultNodes/" class="md-nav__link">
        List of Default Nodes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nodes/NODES/" class="md-nav__link">
        Workflow Editor Usage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nodes/comfyToInvoke/" class="md-nav__link">
        ComfyUI to InvokeAI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nodes/detailedNodes/faceTools/" class="md-nav__link">
        Facetool Node
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nodes/contributingNodes/" class="md-nav__link">
        Contributing Nodes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../features/">Features</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Features
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../help/gettingStartedWithAI/" class="md-nav__link">
        New to InvokeAI?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/CONFIGURATION/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/CONTROLNET/" class="md-nav__link">
        Control Adapters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/IMG2IMG/" class="md-nav__link">
        Image-to-Image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/LOGGING/" class="md-nav__link">
        Controlling Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/LORAS/" class="md-nav__link">
        LoRAs & LCM-LoRAs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/MODEL_MERGING/" class="md-nav__link">
        Model Merging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nodes/overview/" class="md-nav__link">
        Nodes & Workflows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/WATERMARK%2BNSFW/" class="md-nav__link">
        NSFW Checker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/POSTPROCESS/" class="md-nav__link">
        Postprocessing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/PROMPTS/" class="md-nav__link">
        Prompting Features
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_13" >
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_13" id="__nav_4_13_label" tabindex="0">
          Textual Inversions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_13_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_13">
          <span class="md-nav__icon md-icon"></span>
          Textual Inversions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/TEXTUAL_INVERSIONS/" class="md-nav__link">
        Textual Inversions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/TRAINING/" class="md-nav__link">
        Textual Inversion Training
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/UNIFIED_CANVAS/" class="md-nav__link">
        Unified Canvas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/WEB/" class="md-nav__link">
        InvokeAI Web Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/WEBUIHOTKEYS/" class="md-nav__link">
        WebUI Hotkeys
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/UTILITIES/" class="md-nav__link">
        Maintenance Utilities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../features/OTHER/" class="md-nav__link">
        Other
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Contributing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Contributing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../CONTRIBUTING/" class="md-nav__link">
        How to Contribute
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CODE_OF_CONDUCT/" class="md-nav__link">
        InvokeAI Code of Conduct
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
          Development
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Development
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contribution_guides/development/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contribution_guides/newContributorChecklist/" class="md-nav__link">
        New Contributors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ARCHITECTURE/" class="md-nav__link">
        InvokeAI Architecture
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contribution_guides/contributingToFrontend/" class="md-nav__link">
        Frontend Documentation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../LOCAL_DEVELOPMENT/" class="md-nav__link">
        Local Development
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../TESTS/" class="md-nav__link">
        Adding Tests
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contribution_guides/documentation/" class="md-nav__link">
        Documentation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../INVOCATIONS/" class="md-nav__link">
        Nodes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contribution_guides/translation/" class="md-nav__link">
        Translation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contribution_guides/tutorials/" class="md-nav__link">
        Tutorials
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../CHANGELOG/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Deprecated
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Deprecated
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../deprecated/CLI/" class="md-nav__link">
        Command Line Interface
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../deprecated/VARIATIONS/" class="md-nav__link">
        Variations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../deprecated/TRANSLATION/" class="md-nav__link">
        Translations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../deprecated/EMBIGGEN/" class="md-nav__link">
        Embiggen
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../deprecated/INPAINTING/" class="md-nav__link">
        Inpainting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../deprecated/OUTPAINTING/" class="md-nav__link">
        Outpainting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../help/deprecated/TROUBLESHOOT/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Help
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Help
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../help/gettingStartedWithAI/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../help/FAQ/" class="md-nav__link">
        FAQs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../help/diffusion/" class="md-nav__link">
        Diffusion Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../help/SAMPLER_CONVERGENCE/" class="md-nav__link">
        Sampler Convergence
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          Other
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Other
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../other/CONTRIBUTORS/" class="md-nav__link">
        Contributors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../other/README-CompViz/" class="md-nav__link">
        CompViz-README
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="introduction-to-the-model-manager-v2">Introduction to the Model Manager V2<a class="headerlink" href="#introduction-to-the-model-manager-v2" title="Permanent link">#</a></h1>
<p>The Model Manager is responsible for organizing the various machine
learning models used by InvokeAI. It consists of a series of
interdependent services that together handle the full lifecycle of a
model. These are the:</p>
<ul>
<li>
<p><em>ModelRecordServiceBase</em> Responsible for managing model metadata and
  configuration information. Among other things, the record service
  tracks the type of the model, its provenance, and where it can be
  found on disk.</p>
</li>
<li>
<p><em>ModelLoadServiceBase</em> Responsible for loading a model from disk
  into RAM and VRAM and getting it ready for inference.</p>
</li>
<li>
<p><em>DownloadQueueServiceBase</em> A multithreaded downloader responsible
  for downloading models from a remote source to disk. The download
  queue has special methods for downloading repo_id folders from
  Hugging Face, as well as discriminating among model versions in
  Civitai, but can be used for arbitrary content.</p>
</li>
<li>
<p><em>ModelInstallServiceBase</em> A service for installing models to
  disk. It uses <code>DownloadQueueServiceBase</code> to download models and
  their metadata, and <code>ModelRecordServiceBase</code> to store that
  information. It is also responsible for managing the InvokeAI
  <code>models</code> directory and its contents.</p>
</li>
</ul>
<h2 id="location-of-the-code">Location of the Code<a class="headerlink" href="#location-of-the-code" title="Permanent link">#</a></h2>
<p>All four of these services can be found in
<code>invokeai/app/services</code> in the following directories:</p>
<ul>
<li><code>invokeai/app/services/model_records/</code></li>
<li><code>invokeai/app/services/downloads/</code></li>
<li><code>invokeai/app/services/model_loader/</code></li>
<li><code>invokeai/app/services/model_install/</code></li>
</ul>
<p>With the exception of the install service, each of these is a thin
shell around a corresponding implementation located in
<code>invokeai/backend/model_manager</code>. The main difference between the
modules found in app services and those in the backend folder is that
the former add support for event reporting and are more tied to the
needs of the InvokeAI API.</p>
<p>Code related to the FastAPI web API can be found in
<code>invokeai/app/api/routers/models.py</code>.</p>
<hr />
<h2 id="whats-in-a-model-the-modelrecordservice">What's in a Model? The ModelRecordService<a class="headerlink" href="#whats-in-a-model-the-modelrecordservice" title="Permanent link">#</a></h2>
<p>The <code>ModelRecordService</code> manages the model's metadata. It supports a
hierarchy of pydantic metadata "config" objects, which become
increasingly specialized to support particular model types.</p>
<h3 id="modelconfigbase">ModelConfigBase<a class="headerlink" href="#modelconfigbase" title="Permanent link">#</a></h3>
<p>All model metadata classes inherit from this pydantic class. it
provides the following fields:</p>
<table>
<thead>
<tr>
<th><strong>Field Name</strong></th>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>key</code></td>
<td>str</td>
<td>Unique identifier for the model</td>
</tr>
<tr>
<td><code>name</code></td>
<td>str</td>
<td>Name of the model (not unique)</td>
</tr>
<tr>
<td><code>model_type</code></td>
<td>ModelType</td>
<td>The type of the model</td>
</tr>
<tr>
<td><code>model_format</code></td>
<td>ModelFormat</td>
<td>The format of the model (e.g. "diffusers"); also used as a Union discriminator</td>
</tr>
<tr>
<td><code>base_model</code></td>
<td>BaseModelType</td>
<td>The base model that the model is compatible with</td>
</tr>
<tr>
<td><code>path</code></td>
<td>str</td>
<td>Location of model on disk</td>
</tr>
<tr>
<td><code>original_hash</code></td>
<td>str</td>
<td>Hash of the model when it was first installed</td>
</tr>
<tr>
<td><code>current_hash</code></td>
<td>str</td>
<td>Most recent hash of the model's contents</td>
</tr>
<tr>
<td><code>description</code></td>
<td>str</td>
<td>Human-readable description of the model (optional)</td>
</tr>
<tr>
<td><code>source</code></td>
<td>str</td>
<td>Model's source URL or repo id (optional)</td>
</tr>
</tbody>
</table>
<p>The <code>key</code> is a unique 32-character random ID which was generated at
install time. The <code>original_hash</code> field stores a hash of the model's
contents at install time obtained by sampling several parts of the
model's files using the <code>imohash</code> library. Over the course of the
model's lifetime it may be transformed in various ways, such as
changing its precision or converting it from a .safetensors to a
diffusers model. When this happens, <code>original_hash</code> is unchanged, but
<code>current_hash</code> is updated to indicate the current contents.</p>
<p><code>ModelType</code>, <code>ModelFormat</code> and <code>BaseModelType</code> are string enums that
are defined in <code>invokeai.backend.model_manager.config</code>. They are also
imported by, and can be reexported from,
<code>invokeai.app.services.model_record_service</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>from invokeai.app.services.model_record_service import ModelType, ModelFormat, BaseModelType
</code></pre></div>
<p>The <code>path</code> field can be absolute or relative. If relative, it is taken
to be relative to the <code>models_dir</code> setting in the user's
<code>invokeai.yaml</code> file.</p>
<h3 id="checkpointconfig">CheckpointConfig<a class="headerlink" href="#checkpointconfig" title="Permanent link">#</a></h3>
<p>This adds support for checkpoint configurations, and adds the
following field:</p>
<table>
<thead>
<tr>
<th><strong>Field Name</strong></th>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>config</code></td>
<td>str</td>
<td>Path to the checkpoint's config file</td>
</tr>
</tbody>
</table>
<p><code>config</code> is the path to the checkpoint's config file. If relative, it
is taken to be relative to the InvokeAI root directory
(e.g. <code>configs/stable-diffusion/v1-inference.yaml</code>)</p>
<h3 id="mainconfig">MainConfig<a class="headerlink" href="#mainconfig" title="Permanent link">#</a></h3>
<p>This adds support for "main" Stable Diffusion models, and adds these
fields:</p>
<table>
<thead>
<tr>
<th><strong>Field Name</strong></th>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>vae</code></td>
<td>str</td>
<td>Path to a VAE to use instead of the burnt-in one</td>
</tr>
<tr>
<td><code>variant</code></td>
<td>ModelVariantType</td>
<td>Model variant type, such as "inpainting"</td>
</tr>
</tbody>
</table>
<p><code>vae</code> can be an absolute or relative path. If relative, its base is
taken to be the <code>models_dir</code> directory.</p>
<p><code>variant</code> is an enumerated string class with values <code>normal</code>,
<code>inpaint</code> and <code>depth</code>. If needed, it can be imported if needed from
either <code>invokeai.app.services.model_record_service</code> or
<code>invokeai.backend.model_manager.config</code>.</p>
<h3 id="onnxsd2config">ONNXSD2Config<a class="headerlink" href="#onnxsd2config" title="Permanent link">#</a></h3>
<table>
<thead>
<tr>
<th><strong>Field Name</strong></th>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prediction_type</code></td>
<td>SchedulerPredictionType</td>
<td>Scheduler prediction type to use, e.g. "epsilon"</td>
</tr>
<tr>
<td><code>upcast_attention</code></td>
<td>bool</td>
<td>Model requires its attention module to be upcast</td>
</tr>
</tbody>
</table>
<p>The <code>SchedulerPredictionType</code> enum can be imported from either
<code>invokeai.app.services.model_record_service</code> or
<code>invokeai.backend.model_manager.config</code>.</p>
<h3 id="other-config-classes">Other config classes<a class="headerlink" href="#other-config-classes" title="Permanent link">#</a></h3>
<p>There are a series of such classes each discriminated by their
<code>ModelFormat</code>, including <code>LoRAConfig</code>, <code>IPAdapterConfig</code>, and so
forth. These are rarely needed outside the model manager's internal
code, but available in <code>invokeai.backend.model_manager.config</code> if
needed. There is also a Union of all ModelConfig classes, called
<code>AnyModelConfig</code> that can be imported from the same file.</p>
<h3 id="limitations-of-the-data-model">Limitations of the Data Model<a class="headerlink" href="#limitations-of-the-data-model" title="Permanent link">#</a></h3>
<p>The config hierarchy has a major limitation in its handling of the
base model type. Each model can only be compatible with one base
model, which breaks down in the event of models that are compatible
with two or more base models. For example, SD-1 VAEs also work with
SD-2 models. A partial workaround is to use <code>BaseModelType.Any</code>, which
indicates that the model is compatible with any of the base
models. This works OK for some models, such as the IP Adapter image
encoders, but is an all-or-nothing proposition.</p>
<p>Another issue is that the config class hierarchy is paralleled to some
extent by a <code>ModelBase</code> class hierarchy defined in
<code>invokeai.backend.model_manager.models.base</code> and its subclasses. These
are classes representing the models after they are loaded into RAM and
include runtime information such as load status and bytes used. Some
of the fields, including <code>name</code>, <code>model_type</code> and <code>base_model</code>, are
shared between <code>ModelConfigBase</code> and <code>ModelBase</code>, and this is a
potential source of confusion.</p>
<p>** TO DO: ** The <code>ModelBase</code> code needs to be revised to reduce the
duplication of similar classes and to support using the <code>key</code> as the
primary model identifier.</p>
<h2 id="reading-and-writing-model-configuration-records">Reading and Writing Model Configuration Records<a class="headerlink" href="#reading-and-writing-model-configuration-records" title="Permanent link">#</a></h2>
<p>The <code>ModelRecordService</code> provides the ability to retrieve model
configuration records from SQL or YAML databases, update them, and
write them back.</p>
<p>A application-wide <code>ModelRecordService</code> is created during API
initialization and can be retrieved within an invocation from the
<code>InvocationContext</code> object:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>store = context.services.model_record_store
</code></pre></div>
<p>or from elsewhere in the code by accessing
<code>ApiDependencies.invoker.services.model_record_store</code>.</p>
<h3 id="creating-a-modelrecordservice">Creating a <code>ModelRecordService</code><a class="headerlink" href="#creating-a-modelrecordservice" title="Permanent link">#</a></h3>
<p>To create a new <code>ModelRecordService</code> database or open an existing one,
you can directly create either a <code>ModelRecordServiceSQL</code> or a
<code>ModelRecordServiceFile</code> object:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>from invokeai.app.services.model_record_service import ModelRecordServiceSQL, ModelRecordServiceFile
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>store = ModelRecordServiceSQL.from_connection(connection, lock)
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>store = ModelRecordServiceSQL.from_db_file(&#39;/path/to/sqlite_database.db&#39;)
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>store = ModelRecordServiceFile.from_db_file(&#39;/path/to/database.yaml&#39;)
</code></pre></div>
<p>The <code>from_connection()</code> form is only available from the
<code>ModelRecordServiceSQL</code> class, and is used to manage records in a
previously-opened SQLITE3 database using a <code>sqlite3.connection</code> object
and a <code>threading.lock</code> object. It is intended for the specific use
case of storing the record information in the main InvokeAI database,
usually <code>databases/invokeai.db</code>.</p>
<p>The <code>from_db_file()</code> methods can be used to open new connections to
the named database files. If the file doesn't exist, it will be
created and initialized.</p>
<p>As a convenience, <code>ModelRecordServiceBase</code> offers two methods,
<code>from_db_file</code> and <code>open</code>, which will return either a SQL or File
implementation depending on the context. The former looks at the file
extension to determine whether to open the file as a SQL database
(".db") or as a file database (".yaml"). If the file exists, but is
either the wrong type or does not contain the expected schema
metainformation, then an appropriate <code>AssertionError</code> will be raised:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>store = ModelRecordServiceBase.from_db_file(&#39;/path/to/a/file.{yaml,db}&#39;)
</code></pre></div>
<p>The <code>ModelRecordServiceBase.open()</code> method is specifically designed
for use in the InvokeAI web server. Its signature is:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>def open(
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>       cls, 
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>       config: InvokeAIAppConfig, 
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>       conn: Optional[sqlite3.Connection] = None, 
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>       lock: Optional[threading.Lock] = None
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    ) -&gt; Union[ModelRecordServiceSQL, ModelRecordServiceFile]:
</code></pre></div>
<p>The way it works is as follows:</p>
<ol>
<li>Retrieve the value of the <code>model_config_db</code> option from the user's
    <code>invokeai.yaml</code> config file.</li>
<li>If <code>model_config_db</code> is <code>auto</code> (the default), then:</li>
<li>Use the values of <code>conn</code> and <code>lock</code> to return a <code>ModelRecordServiceSQL</code> object
     opened on the passed connection and lock.</li>
<li>Open up a new connection to <code>databases/invokeai.db</code> if <code>conn</code>
     and/or <code>lock</code> are missing (see note below).</li>
<li>If <code>model_config_db</code> is a Path, then use <code>from_db_file</code>
   to return the appropriate type of ModelRecordService.</li>
<li>If <code>model_config_db</code> is None, then retrieve the legacy
   <code>conf_path</code> option from <code>invokeai.yaml</code> and use the Path
   indicated there. This will default to <code>configs/models.yaml</code>.</li>
</ol>
<p>So a typical startup pattern would be:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>import sqlite3
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>from invokeai.app.services.thread import lock
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>from invokeai.app.services.model_record_service import ModelRecordServiceBase
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>from invokeai.app.services.config import InvokeAIAppConfig
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>config = InvokeAIAppConfig.get_config()
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>db_conn = sqlite3.connect(config.db_path.as_posix(), check_same_thread=False)
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>store = ModelRecordServiceBase.open(config, db_conn, lock)
</code></pre></div>
<p><em>A note on simultaneous access to <code>invokeai.db</code></em>: The current InvokeAI
service architecture for the image and graph databases is careful to
use a shared sqlite3 connection and a thread lock to ensure that two
threads don't attempt to access the database simultaneously. However,
the default <code>sqlite3</code> library used by Python reports using
<strong>Serialized</strong> mode, which allows multiple threads to access the
database simultaneously using multiple database connections (see
<a href="https://www.sqlite.org/threadsafe.html">https://www.sqlite.org/threadsafe.html</a> and
<a href="https://ricardoanderegg.com/posts/python-sqlite-thread-safety/">https://ricardoanderegg.com/posts/python-sqlite-thread-safety/</a>). Therefore
it should be safe to allow the record service to open its own SQLite
database connection. Opening a model record service should then be as
simple as <code>ModelRecordServiceBase.open(config)</code>.</p>
<h3 id="fetching-a-models-configuration-from-modelrecordservicebase">Fetching a Model's Configuration from <code>ModelRecordServiceBase</code><a class="headerlink" href="#fetching-a-models-configuration-from-modelrecordservicebase" title="Permanent link">#</a></h3>
<p>Configurations can be retrieved in several ways.</p>
<h4 id="get_modelkey-anymodelconfig">get_model(key) -&gt; AnyModelConfig:<a class="headerlink" href="#get_modelkey-anymodelconfig" title="Permanent link">#</a></h4>
<p>The basic functionality is to call the record store object's
<code>get_model()</code> method with the desired model's unique key. It returns
the appropriate subclass of ModelConfigBase:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>model_conf = store.get_model(&#39;f13dd932c0c35c22dcb8d6cda4203764&#39;)
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>print(model_conf.path)
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>&gt;&gt; &#39;/tmp/models/ckpts/v1-5-pruned-emaonly.safetensors&#39;
</code></pre></div>
<p>If the key is unrecognized, this call raises an
<code>UnknownModelException</code>.</p>
<h4 id="existskey-anymodelconfig">exists(key) -&gt; AnyModelConfig:<a class="headerlink" href="#existskey-anymodelconfig" title="Permanent link">#</a></h4>
<p>Returns True if a model with the given key exists in the databsae.</p>
<h4 id="search_by_pathpath-anymodelconfig">search_by_path(path) -&gt; AnyModelConfig:<a class="headerlink" href="#search_by_pathpath-anymodelconfig" title="Permanent link">#</a></h4>
<p>Returns the configuration of the model whose path is <code>path</code>. The path
is matched using a simple string comparison and won't correctly match
models referred to by different paths (e.g. using symbolic links).</p>
<h4 id="search_by_namename-base-type-listanymodelconfig">search_by_name(name, base, type) -&gt; List[AnyModelConfig]:<a class="headerlink" href="#search_by_namename-base-type-listanymodelconfig" title="Permanent link">#</a></h4>
<p>This method searches for models that match some combination of <code>name</code>,
<code>BaseType</code> and <code>ModelType</code>. Calling without any arguments will return
all the models in the database.</p>
<h4 id="all_models-listanymodelconfig">all_models() -&gt; List[AnyModelConfig]:<a class="headerlink" href="#all_models-listanymodelconfig" title="Permanent link">#</a></h4>
<p>Return all the model configs in the database. Exactly equivalent to
calling <code>search_by_name()</code> with no arguments.</p>
<h4 id="search_by_tagtags-listanymodelconfig">search_by_tag(tags) -&gt; List[AnyModelConfig]:<a class="headerlink" href="#search_by_tagtags-listanymodelconfig" title="Permanent link">#</a></h4>
<p><code>tags</code> is a list of strings. This method returns a list of model
configs that contain all of the given tags. Examples:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a># find all models that are marked as both SFW and as generating
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a># background scenery
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>configs = store.search_by_tag([&#39;sfw&#39;, &#39;scenery&#39;])
</code></pre></div>
<p>Note that only tags are not searchable in this way. Other fields can
be searched using a filter:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>commercializable_models = [x for x in store.all_models() \
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>                           if x.license.contains(&#39;allowCommercialUse=Sell&#39;)]
</code></pre></div>
<h4 id="version-str">version() -&gt; str:<a class="headerlink" href="#version-str" title="Permanent link">#</a></h4>
<p>Returns the version of the database, currently at <code>3.2</code></p>
<h4 id="model_info_by_namename-base_model-model_type-modelconfigbase">model_info_by_name(name, base_model, model_type) -&gt; ModelConfigBase:<a class="headerlink" href="#model_info_by_namename-base_model-model_type-modelconfigbase" title="Permanent link">#</a></h4>
<p>This method exists to ease the transition from the previous version of
the model manager, in which <code>get_model()</code> took the three arguments
shown above. This looks for a unique model identified by name, base
model and model type and returns it.</p>
<p>The method will generate a <code>DuplicateModelException</code> if there are more
than one models that share the same type, base and name. While
unlikely, it is certainly possible to have a situation in which the
user had added two models with the same name, base and type, one
located at path <code>/foo/my_model</code> and the other at <code>/bar/my_model</code>. It
is strongly recommended to search for models using <code>search_by_name()</code>,
which can return multiple results, and then to select the desired
model and pass its key to <code>get_model()</code>.</p>
<h3 id="writing-model-configs-to-the-database">Writing model configs to the database<a class="headerlink" href="#writing-model-configs-to-the-database" title="Permanent link">#</a></h3>
<p>Several methods allow you to create and update stored model config
records.</p>
<h4 id="add_modelkey-config-modelconfigbase">add_model(key, config) -&gt; ModelConfigBase:<a class="headerlink" href="#add_modelkey-config-modelconfigbase" title="Permanent link">#</a></h4>
<p>Given a key and a configuration, this will add the model's
configuration record to the database. <code>config</code> can either be a subclass of
<code>ModelConfigBase</code> (i.e. any class listed in <code>AnyModelConfig</code>), or a
<code>dict</code> of key/value pairs. In the latter case, the correct
configuration class will be picked by Pydantic's discriminated union
mechanism.</p>
<p>If successful, the method will return the appropriate subclass of
<code>ModelConfigBase</code>. It will raise a <code>DuplicateModelException</code> if a
model with the same key is already in the database, or an
<code>InvalidModelConfigException</code> if a dict was passed and Pydantic
experienced a parse or validation error.</p>
<h3 id="update_modelkey-config-anymodelconfig">update_model(key, config) -&gt; AnyModelConfig:<a class="headerlink" href="#update_modelkey-config-anymodelconfig" title="Permanent link">#</a></h3>
<p>Given a key and a configuration, this will update the model
configuration record in the database. <code>config</code> can be either a
instance of <code>ModelConfigBase</code>, or a sparse <code>dict</code> containing the
fields to be updated. This will return an <code>AnyModelConfig</code> on success,
or raise <code>InvalidModelConfigException</code> or <code>UnknownModelException</code>
exceptions on failure.</p>
<p><strong><em>TO DO:</em></strong> Investigate why <code>update_model()</code> returns an
<code>AnyModelConfig</code> while <code>add_model()</code> returns a <code>ModelConfigBase</code>.</p>
<h3 id="rename_modelkey-new_name-modelconfigbase">rename_model(key, new_name) -&gt; ModelConfigBase:<a class="headerlink" href="#rename_modelkey-new_name-modelconfigbase" title="Permanent link">#</a></h3>
<p>This is a special case of <code>update_model()</code> for the use case of
changing the model's name. It is broken out because there are cases in
which the InvokeAI application wants to synchronize the model's name
with its path in the <code>models</code> directory after changing the name, type
or base. However, when using the ModelRecordService directly, the call
is equivalent to:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>store.rename_model(key, {&#39;name&#39;: &#39;new_name&#39;})
</code></pre></div>
<p><strong><em>TO DO:</em></strong> Investigate why <code>rename_model()</code> is returning a
<code>ModelConfigBase</code> while <code>update_model()</code> returns a <code>AnyModelConfig</code>.</p>
<hr />
<h2 id="lets-get-loaded-the-lowdown-on-modelloadservice">Let's get loaded, the lowdown on ModelLoadService<a class="headerlink" href="#lets-get-loaded-the-lowdown-on-modelloadservice" title="Permanent link">#</a></h2>
<p>The <code>ModelLoadService</code> is responsible for loading a named model into
memory so that it can be used for inference. Despite the fact that it
does a lot under the covers, it is very straightforward to use.</p>
<p>An application-wide model loader is created at API initialization time
and stored in
<code>ApiDependencies.invoker.services.model_loader</code>. However, you can
create alternative instances if you wish.</p>
<h3 id="creating-a-modelloadservice-object">Creating a ModelLoadService object<a class="headerlink" href="#creating-a-modelloadservice-object" title="Permanent link">#</a></h3>
<p>The class is defined in
<code>invokeai.app.services.model_loader_service</code>. It is initialized with
an InvokeAIAppConfig object, from which it gets configuration
information such as the user's desired GPU and precision, and with a
previously-created <code>ModelRecordServiceBase</code> object, from which it
loads the requested model's configuration information.</p>
<p>Here is a typical initialization pattern:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>from invokeai.app.services.config import InvokeAIAppConfig
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>from invokeai.app.services.model_record_service import ModelRecordServiceBase
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>from invokeai.app.services.model_loader_service import ModelLoadService
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>config = InvokeAIAppConfig.get_config()
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>store = ModelRecordServiceBase.open(config)
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>loader = ModelLoadService(config, store)
</code></pre></div>
<p>Note that we are relying on the contents of the application
configuration to choose the implementation of
<code>ModelRecordServiceBase</code>.</p>
<h3 id="get_modelkey-submodel_type-context-modelinfo">get_model(key, [submodel_type], [context]) -&gt; ModelInfo:<a class="headerlink" href="#get_modelkey-submodel_type-context-modelinfo" title="Permanent link">#</a></h3>
<p>*** TO DO: change to get_model(key, context=None, **kwargs)</p>
<p>The <code>get_model()</code> method, like its similarly-named cousin in
<code>ModelRecordService</code>, receives the unique key that identifies the
model.  It loads the model into memory, gets the model ready for use,
and returns a <code>ModelInfo</code> object. </p>
<p>The optional second argument, <code>subtype</code> is a <code>SubModelType</code> string
enum, such as "vae". It is mandatory when used with a main model, and
is used to select which part of the main model to load.</p>
<p>The optional third argument, <code>context</code> can be provided by
an invocation to trigger model load event reporting. See below for
details.</p>
<p>The returned <code>ModelInfo</code> object shares some fields in common with
<code>ModelConfigBase</code>, but is otherwise a completely different beast:</p>
<table>
<thead>
<tr>
<th><strong>Field Name</strong></th>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>key</code></td>
<td>str</td>
<td>The model key derived from the ModelRecordService database</td>
</tr>
<tr>
<td><code>name</code></td>
<td>str</td>
<td>Name of this model</td>
</tr>
<tr>
<td><code>base_model</code></td>
<td>BaseModelType</td>
<td>Base model for this model</td>
</tr>
<tr>
<td><code>type</code></td>
<td>ModelType or SubModelType</td>
<td>Either the model type (non-main) or the submodel type (main models)</td>
</tr>
<tr>
<td><code>location</code></td>
<td>Path or str</td>
<td>Location of the model on the filesystem</td>
</tr>
<tr>
<td><code>precision</code></td>
<td>torch.dtype</td>
<td>The torch.precision to use for inference</td>
</tr>
<tr>
<td><code>context</code></td>
<td>ModelCache.ModelLocker</td>
<td>A context class used to lock the model in VRAM while in use</td>
</tr>
</tbody>
</table>
<p>The types for <code>ModelInfo</code> and <code>SubModelType</code> can be imported from
<code>invokeai.app.services.model_loader_service</code>.</p>
<p>To use the model, you use the <code>ModelInfo</code> as a context manager using
the following pattern:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>model_info = loader.get_model(&#39;f13dd932c0c35c22dcb8d6cda4203764&#39;, SubModelType(&#39;vae&#39;))
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>with model_info as vae:
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    image = vae.decode(latents)[0]
</code></pre></div>
<p>The <code>vae</code> model will stay locked in the GPU during the period of time
it is in the context manager's scope.</p>
<p><code>get_model()</code> may raise any of the following exceptions:</p>
<ul>
<li><code>UnknownModelException</code>  -- key not in database</li>
<li><code>ModelNotFoundException</code> -- key in database but model not found at path</li>
<li><code>InvalidModelException</code>  -- the model is guilty of a variety of sins</li>
</ul>
<p>** TO DO: ** Resolve discrepancy between ModelInfo.location and
ModelConfig.path.</p>
<h3 id="emitting-model-loading-events">Emitting model loading events<a class="headerlink" href="#emitting-model-loading-events" title="Permanent link">#</a></h3>
<p>When the <code>context</code> argument is passed to <code>get_model()</code>, it will
retrieve the invocation event bus from the passed <code>InvocationContext</code>
object to emit events on the invocation bus. The two events are
"model_load_started" and "model_load_completed". Both carry the
following payload:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>payload=dict(
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>    queue_id=queue_id,
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>    queue_item_id=queue_item_id,
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>    queue_batch_id=queue_batch_id,
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>    graph_execution_state_id=graph_execution_state_id,
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    model_key=model_key,
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    submodel=submodel,
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    hash=model_info.hash,
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    location=str(model_info.location),
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    precision=str(model_info.precision),
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>)
</code></pre></div>
<hr />
<h2 id="get-on-line-the-download-queue">Get on line: The Download Queue<a class="headerlink" href="#get-on-line-the-download-queue" title="Permanent link">#</a></h2>
<p>InvokeAI can download arbitrary files using a multithreaded background
download queue. Internally, the download queue is used for installing
models located at remote locations. The queue is implemented by the
<code>DownloadQueueService</code> defined in
<code>invokeai.app.services.download_manager</code>. However, most of the
implementation is spread out among several files in
<code>invokeai/backend/model_manager/download/*</code></p>
<p>A default download queue is located in
<code>ApiDependencies.invoker.services.download_queue</code>. However, you can
create additional instances if you need to isolate your queue from the
main one.</p>
<h3 id="a-job-for-every-task">A job for every task<a class="headerlink" href="#a-job-for-every-task" title="Permanent link">#</a></h3>
<p>The queue operates on a series of download job objects. These objects
specify the source and destination of the download, and keep track of
the progress of the download. Jobs come in a variety of shapes and
colors as they are progressively specialized for particular download
task.</p>
<p>The basic job is the <code>DownloadJobBase</code>, a pydantic object with the
following fields:</p>
<table>
<thead>
<tr>
<th><strong>Field</strong></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>int</td>
<td></td>
<td>Job ID, an integer &gt;= 0</td>
</tr>
<tr>
<td><code>priority</code></td>
<td>int</td>
<td>10</td>
<td>Job priority. Lower priorities run before higher priorities</td>
</tr>
<tr>
<td><code>source</code></td>
<td>str</td>
<td></td>
<td>Where to download from (specialized types used in subclasses)</td>
</tr>
<tr>
<td><code>destination</code></td>
<td>Path</td>
<td></td>
<td>Where to download to</td>
</tr>
<tr>
<td><code>status</code></td>
<td>DownloadJobStatus</td>
<td>Idle</td>
<td>Job's status (see below)</td>
</tr>
<tr>
<td><code>event_handlers</code></td>
<td>List[DownloadEventHandler]</td>
<td></td>
<td>Event handlers (see below)</td>
</tr>
<tr>
<td><code>job_started</code></td>
<td>float</td>
<td></td>
<td>Timestamp for when the job started running</td>
</tr>
<tr>
<td><code>job_ended</code></td>
<td>float</td>
<td></td>
<td>Timestamp for when the job completed or errored out</td>
</tr>
<tr>
<td><code>job_sequence</code></td>
<td>int</td>
<td></td>
<td>A counter that is incremented each time a model is dequeued</td>
</tr>
<tr>
<td><code>preserve_partial_downloads</code></td>
<td>bool</td>
<td>False</td>
<td>Resume partial downloads when relaunched.</td>
</tr>
<tr>
<td><code>error</code></td>
<td>Exception</td>
<td></td>
<td>A copy of the Exception that caused an error during download</td>
</tr>
</tbody>
</table>
<p>When you create a job, you can assign it a <code>priority</code>. If multiple
jobs are queued, the job with the lowest priority runs first. (Don't
blame me! The Unix developers came up with this convention.) </p>
<p>Every job has a <code>source</code> and a <code>destination</code>. <code>source</code> is a string in
the base class, but subclassses redefine it more specifically.</p>
<p>The <code>destination</code> must be the Path to a file or directory on the local
filesystem. If the Path points to a new or existing file, then the
source will be stored under that filename. If the Path ponts to an
existing directory, then the downloaded file will be stored inside the
directory, usually using the name assigned to it at the remote site in
the <code>content-disposition</code> http field.</p>
<p>When the job is submitted, it is assigned a numeric <code>id</code>. The id can
then be used to control the job, such as starting, stopping and
cancelling its download.</p>
<p>The <code>status</code> field is updated by the queue to indicate where the job
is in its lifecycle. Values are defined in the string enum
<code>DownloadJobStatus</code>, a symbol available from
<code>invokeai.app.services.download_manager</code>. Possible values are:</p>
<table>
<thead>
<tr>
<th><strong>Value</strong></th>
<th><strong>String Value</strong></th>
<th>** Description **</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>IDLE</code></td>
<td>idle</td>
<td>Job created, but not submitted to the queue</td>
</tr>
<tr>
<td><code>ENQUEUED</code></td>
<td>enqueued</td>
<td>Job is patiently waiting on the queue</td>
</tr>
<tr>
<td><code>RUNNING</code></td>
<td>running</td>
<td>Job is running!</td>
</tr>
<tr>
<td><code>PAUSED</code></td>
<td>paused</td>
<td>Job was paused and can be restarted</td>
</tr>
<tr>
<td><code>COMPLETED</code></td>
<td>completed</td>
<td>Job has finished its work without an error</td>
</tr>
<tr>
<td><code>ERROR</code></td>
<td>error</td>
<td>Job encountered an error and will not run again</td>
</tr>
<tr>
<td><code>CANCELLED</code></td>
<td>cancelled</td>
<td>Job was cancelled and will not run (again)</td>
</tr>
</tbody>
</table>
<p><code>job_started</code>, <code>job_ended</code> and <code>job_sequence</code> indicate when the job
was started (using a python timestamp), when it completed, and the
order in which it was taken off the queue. These are mostly used for
debugging and performance testing.</p>
<p>In case of an error, the Exception that caused the error will be
placed in the <code>error</code> field, and the job's status will be set to
<code>DownloadJobStatus.ERROR</code>. </p>
<p>After an error occurs, any partially downloaded files will be deleted
from disk, unless <code>preserve_partial_downloads</code> was set to True at job
creation time (or set to True any time before the error
occurred). Note that since all InvokeAI model install operations
involve downloading files to a temporary directory that has a limited
lifetime, this flag is not used by the model installer.</p>
<p>There are a series of subclasses of <code>DownloadJobBase</code> that provide
support for specific types of downloads. These are:</p>
<h4 id="downloadjobpath">DownloadJobPath<a class="headerlink" href="#downloadjobpath" title="Permanent link">#</a></h4>
<p>This subclass redefines <code>source</code> to be a filesystem Path. It is used
to move a file or directory from the <code>source</code> to the <code>destination</code>
paths in the background using a uniform event-based infrastructure.</p>
<h4 id="downloadjobremotesource">DownloadJobRemoteSource<a class="headerlink" href="#downloadjobremotesource" title="Permanent link">#</a></h4>
<p>This subclass adds the following fields to the job:</p>
<table>
<thead>
<tr>
<th><strong>Field</strong></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bytes</code></td>
<td>int</td>
<td>0</td>
<td>bytes downloaded so far</td>
</tr>
<tr>
<td><code>total_bytes</code></td>
<td>int</td>
<td>0</td>
<td>total size to download</td>
</tr>
<tr>
<td><code>access_token</code></td>
<td>Any</td>
<td>None</td>
<td>an authorization token to present to the remote source</td>
</tr>
</tbody>
</table>
<p>The job will start out with 0/0 in its bytes/total_bytes fields. Once
it starts running, <code>total_bytes</code> will be populated from information
provided in the HTTP download header (if available), and the number of
bytes downloaded so far will be progressively incremented.</p>
<h4 id="downloadjoburl">DownloadJobURL<a class="headerlink" href="#downloadjoburl" title="Permanent link">#</a></h4>
<p>This is a subclass of <code>DownloadJobBase</code>. It redefines <code>source</code> to be a
Pydantic <code>AnyHttpUrl</code> object, which enforces URL validation checking
on the field.</p>
<p>Note that the installer service defines an additional subclass of
<code>DownloadJobRemoteSource</code> that accepts HuggingFace repo_ids in
addition to URLs. This is discussed later in this document.</p>
<h3 id="event-handlers">Event handlers<a class="headerlink" href="#event-handlers" title="Permanent link">#</a></h3>
<p>While a job is being downloaded, the queue will emit events at
periodic intervals. A typical series of events during a successful
download session will look like this:</p>
<ul>
<li>enqueued</li>
<li>running</li>
<li>running</li>
<li>running</li>
<li>completed</li>
</ul>
<p>There will be a single enqueued event, followed by one or more running
events, and finally one <code>completed</code>, <code>error</code> or <code>cancelled</code>
events.</p>
<p>It is possible for a caller to pause download temporarily, in which
case the events may look something like this:</p>
<ul>
<li>enqueued</li>
<li>running</li>
<li>running</li>
<li>paused</li>
<li>running</li>
<li>completed</li>
</ul>
<p>The download queue logs when downloads start and end (unless <code>quiet</code>
is set to True at initialization time) but doesn't log any progress
events. You will probably want to be alerted to events during the
download job and provide more user feedback. In order to intercept and
respond to events you may install a series of one or more event
handlers in the job. Whenever the job's status changes, the chain of
event handlers is traversed and executed in the same thread that the
download job is running in.</p>
<p>Event handlers have the signature <code>Callable[["DownloadJobBase"],
None]</code>, i.e.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>def handler(job: DownloadJobBase):
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>   pass
</code></pre></div>
<p>A typical handler will examine <code>job.status</code> and decide if there's
something to be done. This can include cancelling or erroring the job,
but more typically is used to report on the job status to the user
interface or to perform certain actions on successful completion of
the job.</p>
<p>Event handlers can be attached to a job at creation time. In addition,
you can create a series of default handlers that are attached to the
queue object itself. These handlers will be executed for each job
after the job's own handlers (if any) have run.</p>
<p>During a download, running events are issued every time roughly 1% of
the file is transferred. This is to provide just enough granularity to
update a tqdm progress bar smoothly.</p>
<p>Handlers can be added to a job after the fact using the job's
<code>add_event_handler</code> method:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>job.add_event_handler(my_handler)
</code></pre></div>
<p>All handlers can be cleared using the job's <code>clear_event_handlers()</code>
method. Note that it might be a good idea to pause the job before
altering its handlers.</p>
<h3 id="creating-a-download-queue-object">Creating a download queue object<a class="headerlink" href="#creating-a-download-queue-object" title="Permanent link">#</a></h3>
<p>The <code>DownloadQueueService</code> constructor takes the following arguments:</p>
<table>
<thead>
<tr>
<th><strong>Argument</strong></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>event_handlers</code></td>
<td>List[DownloadEventHandler]</td>
<td>[]</td>
<td>Event handlers</td>
</tr>
<tr>
<td><code>max_parallel_dl</code></td>
<td>int</td>
<td>5</td>
<td>Maximum number of simultaneous downloads allowed</td>
</tr>
<tr>
<td><code>requests_session</code></td>
<td>requests.sessions.Session</td>
<td>None</td>
<td>An alternative requests Session object to use for the download</td>
</tr>
<tr>
<td><code>quiet</code></td>
<td>bool</td>
<td>False</td>
<td>Do work quietly without issuing log messages</td>
</tr>
</tbody>
</table>
<p>A typical initialization sequence will look like:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>from invokeai.app.services.download_manager import DownloadQueueService
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>def log_download_event(job: DownloadJobBase):
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    logger.info(f&#39;job={job.id}: status={job.status}&#39;)
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>queue = DownloadQueueService(
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>                      event_handlers=[log_download_event]
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>                          )
</code></pre></div>
<p>Event handlers can be provided to the queue at initialization time as
shown in the example. These will be automatically appended to the
handler list for any job that is submitted to this queue.</p>
<p><code>max_parallel_dl</code> sets the number of simultaneous active downloads
that are allowed. The default of five has not been benchmarked in any
way, but seems to give acceptable performance.</p>
<p><code>requests_session</code> can be used to provide a <code>requests</code> module Session
object that will be used to stream remote URLs to disk. This facility
was added for use in the module's unit tests to simulate a remote web
server, but may be useful in other contexts.</p>
<p><code>quiet</code> will prevent the queue from issuing any log messages at the
INFO or higher levels.</p>
<h3 id="submitting-a-download-job">Submitting a download job<a class="headerlink" href="#submitting-a-download-job" title="Permanent link">#</a></h3>
<p>You can submit a download job to the queue either by creating the job
manually and passing it to the queue's <code>submit_download_job()</code> method,
or using the <code>create_download_job()</code> method, which will do the same
thing on your behalf.</p>
<p>To use the former method, follow this example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>job = DownloadJobRemoteSource(
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>         source=&#39;http://www.civitai.com/models/13456&#39;,
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>         destination=&#39;/tmp/models/&#39;,
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>         event_handlers=[my_handler1, my_handler2], # if desired
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>         )
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>queue.submit_download_job(job, start=True)
</code></pre></div>
<p><code>submit_download_job()</code> takes just two arguments: the job to submit,
and a flag indicating whether to immediately start the job (defaulting
to True). If you choose not to start the job immediately, you can
start it later by calling the queue's <code>start_job()</code> or
<code>start_all_jobs()</code> methods, which are described later.</p>
<p>To have the queue create the job for you, follow this example instead:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>job = queue.create_download_job(
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>         source=&#39;http://www.civitai.com/models/13456&#39;,
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>         destdir=&#39;/tmp/models/&#39;,
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>         filename=&#39;my_model.safetensors&#39;,
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>         event_handlers=[my_handler1, my_handler2], # if desired
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>         start=True,
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    )
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a> ```
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>The `filename` argument forces the downloader to use the specified
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>name for the file rather than the name provided by the remote source,
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>and is equivalent to manually specifying a destination of
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>`/tmp/models/my_model.safetensors&#39; in the submitted job.
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>Here is the full list of arguments that can be provided to
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>`create_download_job()`:
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>| **Argument**     | **Type**                     | **Default** | **Description**                           |
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>|------------------|------------------------------|-------------|-------------------------------------------|
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>| `source`         | Union[str, Path, AnyHttpUrl] |             | Download remote or local source           |
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>| `destdir`        | Path                         |             | Destination directory for downloaded file |
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>| `filename`       | Path                         | None        | Filename for downloaded file              |
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>| `start`          | bool                         | True        | Enqueue the job immediately               |
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>| `priority`       | int                          | 10          | Starting priority for this job            |
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>| `access_token`   | str                          | None        | Authorization token for this resource     |
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>| `event_handlers` | List[DownloadEventHandler]   | []          | Event handlers for this job                |
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>Internally, `create_download_job()` has a little bit of internal logic
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a>that looks at the type of the source and selects the right subclass of
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>`DownloadJobBase` to create and enqueue. 
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>
<a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>**TODO**: move this logic into its own method for overriding in
<a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>subclasses.
<a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>
<a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>### Job control
<a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>
<a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>Prior to completion, jobs can be controlled with a series of queue
<a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>method calls. Do not attempt to modify jobs by directly writing to
<a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>their fields, as this is likely to lead to unexpected results.
<a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a>
<a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a>Any method that accepts a job argument may raise an
<a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a>`UnknownJobIDException` if the job has not yet been submitted to the
<a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a>queue or was not created by this queue.
<a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>
<a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a>#### queue.join()
<a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a>
<a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a>This method will block until all the active jobs in the queue have
<a id="__codelineno-17-49" name="__codelineno-17-49" href="#__codelineno-17-49"></a>reached a terminal state (completed, errored or cancelled).
<a id="__codelineno-17-50" name="__codelineno-17-50" href="#__codelineno-17-50"></a>
<a id="__codelineno-17-51" name="__codelineno-17-51" href="#__codelineno-17-51"></a>#### jobs = queue.list_jobs()
<a id="__codelineno-17-52" name="__codelineno-17-52" href="#__codelineno-17-52"></a>
<a id="__codelineno-17-53" name="__codelineno-17-53" href="#__codelineno-17-53"></a>This will return a list of all jobs, including ones that have not yet
<a id="__codelineno-17-54" name="__codelineno-17-54" href="#__codelineno-17-54"></a>been enqueued and those that have completed or errored out.
<a id="__codelineno-17-55" name="__codelineno-17-55" href="#__codelineno-17-55"></a>
<a id="__codelineno-17-56" name="__codelineno-17-56" href="#__codelineno-17-56"></a>#### job = queue.id_to_job(int)
<a id="__codelineno-17-57" name="__codelineno-17-57" href="#__codelineno-17-57"></a>
<a id="__codelineno-17-58" name="__codelineno-17-58" href="#__codelineno-17-58"></a>This method allows you to recover a submitted job using its ID.
<a id="__codelineno-17-59" name="__codelineno-17-59" href="#__codelineno-17-59"></a>
<a id="__codelineno-17-60" name="__codelineno-17-60" href="#__codelineno-17-60"></a>#### queue.prune_jobs()
<a id="__codelineno-17-61" name="__codelineno-17-61" href="#__codelineno-17-61"></a>
<a id="__codelineno-17-62" name="__codelineno-17-62" href="#__codelineno-17-62"></a>Remove completed and errored jobs from the job list.
<a id="__codelineno-17-63" name="__codelineno-17-63" href="#__codelineno-17-63"></a>
<a id="__codelineno-17-64" name="__codelineno-17-64" href="#__codelineno-17-64"></a>#### queue.start_job(job)
<a id="__codelineno-17-65" name="__codelineno-17-65" href="#__codelineno-17-65"></a>
<a id="__codelineno-17-66" name="__codelineno-17-66" href="#__codelineno-17-66"></a>If the job was submitted with `start=False`, then it can be started
<a id="__codelineno-17-67" name="__codelineno-17-67" href="#__codelineno-17-67"></a>using this method.
<a id="__codelineno-17-68" name="__codelineno-17-68" href="#__codelineno-17-68"></a>
<a id="__codelineno-17-69" name="__codelineno-17-69" href="#__codelineno-17-69"></a>#### queue.pause_job(job)
<a id="__codelineno-17-70" name="__codelineno-17-70" href="#__codelineno-17-70"></a>
<a id="__codelineno-17-71" name="__codelineno-17-71" href="#__codelineno-17-71"></a>This will temporarily pause the job, if possible. It can later be
<a id="__codelineno-17-72" name="__codelineno-17-72" href="#__codelineno-17-72"></a>restarted and pick up where it left off using `queue.start_job()`.
<a id="__codelineno-17-73" name="__codelineno-17-73" href="#__codelineno-17-73"></a>
<a id="__codelineno-17-74" name="__codelineno-17-74" href="#__codelineno-17-74"></a>#### queue.cancel_job(job)
<a id="__codelineno-17-75" name="__codelineno-17-75" href="#__codelineno-17-75"></a>
<a id="__codelineno-17-76" name="__codelineno-17-76" href="#__codelineno-17-76"></a>This will cancel the job if possible and clean up temporary files and
<a id="__codelineno-17-77" name="__codelineno-17-77" href="#__codelineno-17-77"></a>other resources that it might have been using.
<a id="__codelineno-17-78" name="__codelineno-17-78" href="#__codelineno-17-78"></a>
<a id="__codelineno-17-79" name="__codelineno-17-79" href="#__codelineno-17-79"></a>#### queue.start_all_jobs(), queue.pause_all_jobs(), queue.cancel_all_jobs()
<a id="__codelineno-17-80" name="__codelineno-17-80" href="#__codelineno-17-80"></a>
<a id="__codelineno-17-81" name="__codelineno-17-81" href="#__codelineno-17-81"></a>This will start/pause/cancel all jobs that have been submitted to the
<a id="__codelineno-17-82" name="__codelineno-17-82" href="#__codelineno-17-82"></a>queue and have not yet reached a terminal state.
<a id="__codelineno-17-83" name="__codelineno-17-83" href="#__codelineno-17-83"></a>
<a id="__codelineno-17-84" name="__codelineno-17-84" href="#__codelineno-17-84"></a>## Model installation
<a id="__codelineno-17-85" name="__codelineno-17-85" href="#__codelineno-17-85"></a>
<a id="__codelineno-17-86" name="__codelineno-17-86" href="#__codelineno-17-86"></a>The `ModelInstallService` class implements the
<a id="__codelineno-17-87" name="__codelineno-17-87" href="#__codelineno-17-87"></a>`ModelInstallServiceBase` abstract base class, and provides a one-stop
<a id="__codelineno-17-88" name="__codelineno-17-88" href="#__codelineno-17-88"></a>shop for all your model install needs. It provides the following
<a id="__codelineno-17-89" name="__codelineno-17-89" href="#__codelineno-17-89"></a>functionality:
<a id="__codelineno-17-90" name="__codelineno-17-90" href="#__codelineno-17-90"></a>
<a id="__codelineno-17-91" name="__codelineno-17-91" href="#__codelineno-17-91"></a>- Registering a model config record for a model already located on the
<a id="__codelineno-17-92" name="__codelineno-17-92" href="#__codelineno-17-92"></a>  local filesystem, without moving it or changing its path.
<a id="__codelineno-17-93" name="__codelineno-17-93" href="#__codelineno-17-93"></a>
<a id="__codelineno-17-94" name="__codelineno-17-94" href="#__codelineno-17-94"></a>- Installing a model alreadiy located on the local filesystem, by
<a id="__codelineno-17-95" name="__codelineno-17-95" href="#__codelineno-17-95"></a>  moving it into the InvokeAI root directory under the
<a id="__codelineno-17-96" name="__codelineno-17-96" href="#__codelineno-17-96"></a>  `models` folder (or wherever config parameter `models_dir`
<a id="__codelineno-17-97" name="__codelineno-17-97" href="#__codelineno-17-97"></a>  specifies).
<a id="__codelineno-17-98" name="__codelineno-17-98" href="#__codelineno-17-98"></a>
<a id="__codelineno-17-99" name="__codelineno-17-99" href="#__codelineno-17-99"></a>- Downloading a model from an arbitrary URL and installing it in
<a id="__codelineno-17-100" name="__codelineno-17-100" href="#__codelineno-17-100"></a>  `models_dir`.
<a id="__codelineno-17-101" name="__codelineno-17-101" href="#__codelineno-17-101"></a>
<a id="__codelineno-17-102" name="__codelineno-17-102" href="#__codelineno-17-102"></a>- Special handling for Civitai model URLs which allow the user to
<a id="__codelineno-17-103" name="__codelineno-17-103" href="#__codelineno-17-103"></a>  paste in a model page&#39;s URL or download link. Any metadata provided
<a id="__codelineno-17-104" name="__codelineno-17-104" href="#__codelineno-17-104"></a>  by Civitai, such as trigger terms, are captured and placed in the
<a id="__codelineno-17-105" name="__codelineno-17-105" href="#__codelineno-17-105"></a>  model config record.
<a id="__codelineno-17-106" name="__codelineno-17-106" href="#__codelineno-17-106"></a>
<a id="__codelineno-17-107" name="__codelineno-17-107" href="#__codelineno-17-107"></a>- Special handling for HuggingFace repo_ids to recursively download
<a id="__codelineno-17-108" name="__codelineno-17-108" href="#__codelineno-17-108"></a>  the contents of the repository, paying attention to alternative
<a id="__codelineno-17-109" name="__codelineno-17-109" href="#__codelineno-17-109"></a>  variants such as fp16.
<a id="__codelineno-17-110" name="__codelineno-17-110" href="#__codelineno-17-110"></a>
<a id="__codelineno-17-111" name="__codelineno-17-111" href="#__codelineno-17-111"></a>- Probing of models to determine their type, base type and other key
<a id="__codelineno-17-112" name="__codelineno-17-112" href="#__codelineno-17-112"></a>  information.
<a id="__codelineno-17-113" name="__codelineno-17-113" href="#__codelineno-17-113"></a>
<a id="__codelineno-17-114" name="__codelineno-17-114" href="#__codelineno-17-114"></a>- Interface with the InvokeAI event bus to provide status updates on
<a id="__codelineno-17-115" name="__codelineno-17-115" href="#__codelineno-17-115"></a>  the download, installation and registration process.
<a id="__codelineno-17-116" name="__codelineno-17-116" href="#__codelineno-17-116"></a>
<a id="__codelineno-17-117" name="__codelineno-17-117" href="#__codelineno-17-117"></a>### Initializing the installer
<a id="__codelineno-17-118" name="__codelineno-17-118" href="#__codelineno-17-118"></a>
<a id="__codelineno-17-119" name="__codelineno-17-119" href="#__codelineno-17-119"></a>A default installer is created at InvokeAI api startup time and stored
<a id="__codelineno-17-120" name="__codelineno-17-120" href="#__codelineno-17-120"></a>in `ApiDependencies.invoker.services.model_install_service` and can
<a id="__codelineno-17-121" name="__codelineno-17-121" href="#__codelineno-17-121"></a>also be retrieved from an invocation&#39;s `context` argument with
<a id="__codelineno-17-122" name="__codelineno-17-122" href="#__codelineno-17-122"></a>`context.services.model_install_service`.
<a id="__codelineno-17-123" name="__codelineno-17-123" href="#__codelineno-17-123"></a>
<a id="__codelineno-17-124" name="__codelineno-17-124" href="#__codelineno-17-124"></a>In the event you wish to create a new installer, you may use the
<a id="__codelineno-17-125" name="__codelineno-17-125" href="#__codelineno-17-125"></a>following initialization pattern:
</code></pre></div>
from invokeai.app.services.config import InvokeAIAppConfig
from invokeai.app.services.download_manager import DownloadQueueServive
from invokeai.app.services.model_record_service import ModelRecordServiceBase</p>
<p>config = InvokeAI.get_config()
queue = DownloadQueueService()
store = ModelRecordServiceBase.open(config)
installer = ModelInstallService(config=config, queue=queue, store=store)
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>The full form of `ModelInstallService()` takes the following
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>parameters. Each parameter will default to a reasonable value, but it
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>is recommended that you set them explicitly as shown in the above example.
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>| **Argument**     | **Type**                     | **Default** | **Description**                           |
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>|------------------|------------------------------|-------------|-------------------------------------------|
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>| `config`         | InvokeAIAppConfig        | Use system-wide config  | InvokeAI app configuration object |
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>| `queue`          | DownloadQueueServiceBase  | Create a new download queue for internal use  | Download queue |
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>| `store`          | ModelRecordServiceBase  | Use config to select the database to open  | Config storage database |
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>| `event_bus`      | EventServiceBase        | None | An event bus to send download/install progress events to |
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>| `event_handlers` | List[DownloadEventHandler]  | None | Event handlers for the download queue |
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>Note that if `store` is not provided, then the class will use
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>`ModelRecordServiceBase.open(config)` to select the database to use.
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>Once initialized, the installer will provide the following methods:
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>#### install_job = installer.install_model()
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>The `install_model()` method is the core of the installer. The
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>following illustrates basic usage:
</code></pre></div>
sources = [
    Path('/opt/models/sushi.safetensors'),   # a local safetensors file
    Path('/opt/models/sushi_diffusers/'),    # a local diffusers folder
    'runwayml/stable-diffusion-v1-5',        # a repo_id
    'runwayml/stable-diffusion-v1-5:vae',    # a subfolder within a repo_id
    '<a href="https://civitai.com/api/download/models/63006">https://civitai.com/api/download/models/63006</a>', # a civitai direct download link
    '<a href="https://civitai.com/models/8765?modelVersionId=10638">https://civitai.com/models/8765?modelVersionId=10638</a>',  # civitai model page
    '<a href="https://s3.amazon.com/fjacks/sd-3.safetensors">https://s3.amazon.com/fjacks/sd-3.safetensors</a>', # arbitrary URL
]</p>
<p>for source in sources:
   install_job = installer.install_model(source)</p>
<p>source2key = installer.wait_for_installs()
for source in sources:
    model_key = source2key[source]
    print(f"{source} installed as {model_key}")
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>As shown here, the `install_model()` method accepts a variety of
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>sources, including local safetensors files, local diffusers folders,
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>HuggingFace repo_ids with and without a subfolder designation,
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>Civitai model URLs and arbitrary URLs that point to checkpoint files
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>(but not to folders).
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>Each call to `install_model()` will return a `ModelInstallJob` job, a
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>subclass of `DownloadJobBase`. The install job has additional
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>install-specific fields described in the next section.
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>Each install job will run in a series of background threads using
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>the object&#39;s download queue. You may block until all install jobs are
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>completed (or errored) by calling the `wait_for_installs()` method as
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>shown in the code example. `wait_for_installs()` will return a `dict`
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>that maps the requested source to the key of the installed model. In
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>the case that a model fails to download or install, its value in the
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>dict will be None. The actual cause of the error will be reported in
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>the corresponding job&#39;s `error` field.
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>Alternatively you may install event handlers and/or listen for events
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>on the InvokeAI event bus in order to monitor the progress of the
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>requested installs.
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>The full list of arguments to `model_install()` is as follows:
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>| **Argument**     | **Type**                     | **Default** | **Description**                           |
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a>|------------------|------------------------------|-------------|-------------------------------------------|
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a>| `source`         | Union[str, Path, AnyHttpUrl] |             | The source of the model, Path, URL or repo_id |
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a>| `inplace`        | bool                         | True        | Leave a local model in its current location |
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a>| `variant`        | str                          | None        | Desired variant, such as &#39;fp16&#39; or &#39;onnx&#39; (HuggingFace only) |
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>| `subfolder`      | str                          | None        | Repository subfolder (HuggingFace only)   |
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a>| `probe_override` | Dict[str, Any]               | None        | Override all or a portion of model&#39;s probed attributes |
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a>| `metadata`       | ModelSourceMetadata          | None        | Provide metadata that will be added to model&#39;s config |
<a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>| `access_token`   | str                          | None        | Provide authorization information needed to download |
<a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a>| `priority`       | int                          | 10          | Download queue priority for the job       |
<a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a>
<a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a>
<a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a>The `inplace` field controls how local model Paths are handled. If
<a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a>True (the default), then the model is simply registered in its current
<a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a>location by the installer&#39;s `ModelConfigRecordService`. Otherwise, the
<a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a>model will be moved into the location specified by the  `models_dir`
<a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a>application configuration parameter. 
<a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a>
<a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a>The `variant` field is used for HuggingFace repo_ids only. If
<a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a>provided, the repo_id download handler will look for and download
<a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a>tensors files that follow the convention for the selected variant:
<a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a>
<a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a>- &quot;fp16&quot; will select files named &quot;*model.fp16.{safetensors,bin}&quot;
<a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a>- &quot;onnx&quot; will select files ending with the suffix &quot;.onnx&quot;
<a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a>- &quot;openvino&quot; will select files beginning with &quot;openvino_model&quot;
<a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a>
<a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a>In the special case of the &quot;fp16&quot; variant, the installer will select
<a id="__codelineno-19-53" name="__codelineno-19-53" href="#__codelineno-19-53"></a>the 32-bit version of the files if the 16-bit version is unavailable.
<a id="__codelineno-19-54" name="__codelineno-19-54" href="#__codelineno-19-54"></a>
<a id="__codelineno-19-55" name="__codelineno-19-55" href="#__codelineno-19-55"></a>`subfolder` is used for HuggingFace repo_ids only. If provided, the
<a id="__codelineno-19-56" name="__codelineno-19-56" href="#__codelineno-19-56"></a>model will be downloaded from the designated subfolder rather than the
<a id="__codelineno-19-57" name="__codelineno-19-57" href="#__codelineno-19-57"></a>top-level repository folder. If a subfolder is attached to the repo_id
<a id="__codelineno-19-58" name="__codelineno-19-58" href="#__codelineno-19-58"></a>using the format `repo_owner/repo_name:subfolder`, then the subfolder
<a id="__codelineno-19-59" name="__codelineno-19-59" href="#__codelineno-19-59"></a>specified by the repo_id will override the subfolder argument.
<a id="__codelineno-19-60" name="__codelineno-19-60" href="#__codelineno-19-60"></a>
<a id="__codelineno-19-61" name="__codelineno-19-61" href="#__codelineno-19-61"></a>`probe_override` can be used to override all or a portion of the
<a id="__codelineno-19-62" name="__codelineno-19-62" href="#__codelineno-19-62"></a>attributes returned by the model prober. This can be used to overcome
<a id="__codelineno-19-63" name="__codelineno-19-63" href="#__codelineno-19-63"></a>cases in which automatic probing is unable to (correctly) determine
<a id="__codelineno-19-64" name="__codelineno-19-64" href="#__codelineno-19-64"></a>the model&#39;s attribute. The most common situation is the
<a id="__codelineno-19-65" name="__codelineno-19-65" href="#__codelineno-19-65"></a>`prediction_type` field for sd-2 (and rare sd-1) models. Here is an
<a id="__codelineno-19-66" name="__codelineno-19-66" href="#__codelineno-19-66"></a>example of how it works:
</code></pre></div>
install_job = installer.install_model(
               source='stabilityai/stable-diffusion-2-1',
               variant='fp16',
               probe_override=dict(
                     prediction_type=SchedulerPredictionType('v_prediction')
               )
          )
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>`metadata` allows you to attach custom metadata to the installed
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>model. See the next section for details.
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>`priority` and `access_token` are passed to the download queue and
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>have the same effect as they do for the DownloadQueueServiceBase.
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>#### Monitoring the install job process
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>When you create an install job with `model_install()`, events will be
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>passed to the list of `DownloadEventHandlers` provided at installer
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>initialization time. Event handlers can also be added to individual
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>model install jobs by calling their `add_handler()` method as
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>described earlier for the `DownloadQueueService`.
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>If the `event_bus` argument was provided, events will also be
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>broadcast to the InvokeAI event bus. The events will appear on the bus
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>as a singular event type named `model_event` with a payload of
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>`job`. You can then retrieve the job and check its status.
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>** TO DO: ** consider breaking `model_event` into
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>`model_install_started`, `model_install_completed`, etc. The event bus
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>features have not yet been tested with FastAPI/websockets, and it may
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>turn out that the job object is not serializable.
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>#### Model metadata and probing
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>The install service has special handling for HuggingFace and Civitai
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>URLs that capture metadata from the source and include it in the model
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>configuration record. For example, fetching the Civitai model 8765
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>will produce a config record similar to this (using YAML
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>representation):
</code></pre></div>
5abc3ef8600b6c1cc058480eaae3091e:
  path: sd-1/lora/to8contrast-1-5.safetensors
  name: to8contrast-1-5
  base_model: sd-1
  model_type: lora
  model_format: lycoris
  key: 5abc3ef8600b6c1cc058480eaae3091e
  hash: 5abc3ef8600b6c1cc058480eaae3091e
  description: 'Trigger terms: to8contrast style'
  author: theovercomer8
  license: allowCommercialUse=Sell; allowDerivatives=True; allowNoCredit=True
  source: <a href="https://civitai.com/models/8765?modelVersionId=10638">https://civitai.com/models/8765?modelVersionId=10638</a>
  thumbnail_url: null
  tags:
  - model
  - style
  - portraits
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>For sources that do not provide model metadata, you can attach custom
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>fields by providing a `metadata` argument to `model_install()` using
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>an initialized `ModelSourceMetadata` object (available for import from
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>`model_install_service.py`):
</code></pre></div>
from invokeai.app.services.model_install_service import ModelSourceMetadata
meta = ModelSourceMetadata(
                name="my model",
                author="Sushi Chef",
                description="Highly customized model; trigger with 'sushi',"
                license="mit",
                thumbnail_url="<a href="http://s3.amazon.com/ljack/pics/sushi.png">http://s3.amazon.com/ljack/pics/sushi.png</a>",
                tags=list('sfw', 'food')
            )
install_job = installer.install_model(
               source='sushi_chef/model3',
               variant='fp16',
               metadata=meta,
          )
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>It is not currently recommended to provide custom metadata when
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>installing from Civitai or HuggingFace source, as the metadata
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>provided by the source will overwrite the fields you provide. Instead,
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>after the model is installed you can use
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>`ModelRecordService.update_model()` to change the desired fields.
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>** TO DO: ** Change the logic so that the caller&#39;s metadata fields take
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>precedence over those provided by the source.
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>#### Other installer methods
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>This section describes additional, less-frequently-used attributes and
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>methods provided by the installer class.
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>##### installer.wait_for_installs()
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>This is equivalent to the `DownloadQueue` `join()` method. It will
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>block until all the active jobs in the install queue have reached a
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>terminal state (completed, errored or cancelled).
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>##### installer.queue, installer.store, installer.config
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>These attributes provide access to the `DownloadQueueServiceBase`,
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>`ModelConfigRecordServiceBase`, and `InvokeAIAppConfig` objects that
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>the installer uses.
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>For example, to temporarily pause all pending installations, you can
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>do this:
</code></pre></div>
installer.queue.pause_all_jobs()
```</p>
<h5 id="key-installerregister_pathmodel_path-overrides-key-installerinstall_pathmodel_path-overrides">key = installer.register_path(model_path, overrides), key = installer.install_path(model_path, overrides)<a class="headerlink" href="#key-installerregister_pathmodel_path-overrides-key-installerinstall_pathmodel_path-overrides" title="Permanent link">#</a></h5>
<p>These methods bypass the download queue and directly register or
install the model at the indicated path, returning the unique ID for
the installed model.</p>
<p>Both methods accept a Path object corresponding to a checkpoint or
diffusers folder, and an optional dict of attributes to use to
override the values derived from model probing.</p>
<p>The difference between <code>register_path()</code> and <code>install_path()</code> is that
the former will not move the model from its current position, while
the latter will move it into the <code>models_dir</code> hierarchy.</p>
<h5 id="installerunregisterkey">installer.unregister(key)<a class="headerlink" href="#installerunregisterkey" title="Permanent link">#</a></h5>
<p>This will remove the model config record for the model at key, and is
equivalent to <code>installer.store.unregister(key)</code></p>
<h5 id="installerdeletekey">installer.delete(key)<a class="headerlink" href="#installerdeletekey" title="Permanent link">#</a></h5>
<p>This is similar to <code>unregister()</code> but has the additional effect of
deleting the underlying model file(s) -- even if they were outside the
<code>models_dir</code> directory!</p>
<h5 id="installerconditionally_deletekey">installer.conditionally_delete(key)<a class="headerlink" href="#installerconditionally_deletekey" title="Permanent link">#</a></h5>
<p>This method will call <code>unregister()</code> if the model identified by <code>key</code>
is outside the <code>models_dir</code> hierarchy, and call <code>delete()</code> if the
model is inside.</p>
<h4 id="liststrinstallerscan_directoryscan_dir-path-install-bool">List[str]=installer.scan_directory(scan_dir: Path, install: bool)<a class="headerlink" href="#liststrinstallerscan_directoryscan_dir-path-install-bool" title="Permanent link">#</a></h4>
<p>This method will recursively scan the directory indicated in
<code>scan_dir</code> for new models and either install them in the models
directory or register them in place, depending on the setting of
<code>install</code> (default False).</p>
<p>The return value is the list of keys of the new installed/registered
models.</p>
<h4 id="installerscan_models_directory">installer.scan_models_directory()<a class="headerlink" href="#installerscan_models_directory" title="Permanent link">#</a></h4>
<p>This method scans the models directory for new models and registers
them in place. Models that are present in the
<code>ModelConfigRecordService</code> database whose paths are not found will be
unregistered.</p>
<h4 id="installersync_to_config">installer.sync_to_config()<a class="headerlink" href="#installersync_to_config" title="Permanent link">#</a></h4>
<p>This method synchronizes models in the models directory and autoimport
directory to those in the <code>ModelConfigRecordService</code> database. New
models are registered and orphan models are unregistered.</p>
<h4 id="hashinstallerhashmodel_path">hash=installer.hash(model_path)<a class="headerlink" href="#hashinstallerhashmodel_path" title="Permanent link">#</a></h4>
<p>This method is calls the fasthash algorithm on a model's Path
(either a file or a folder) to generate a unique ID based on the
contents of the model.</p>
<h5 id="installerstartinvoker">installer.start(invoker)<a class="headerlink" href="#installerstartinvoker" title="Permanent link">#</a></h5>
<p>The <code>start</code> method is called by the API intialization routines when
the API starts up. Its effect is to call <code>sync_to_config()</code> to
synchronize the model record store database with what's currently on
disk.</p>
<p>This method should not ordinarily be called manually.</p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">November 5, 2023</span>
      
        <br>
        Created:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">November 5, 2023</span>
      
    
  </small>
</div>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 InvokeAI Team
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.indexes", "navigation.path", "search.highlight", "search.suggest", "toc.integrate"], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
        
          <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
        
      
        
          <script src="../../javascripts/tablesort.js"></script>
        
      
    
  </body>
</html>